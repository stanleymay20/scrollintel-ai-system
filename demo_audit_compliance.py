"""
Demo Script for ScrollIntel Audit Logging and Compliance System

Demonstrates comprehensive audit logging, compliance reporting, data retention,
and audit trail export capabilities for the Launch MVP.
"""

import asyncio
import json
from datetime import datetime, timedelta
from pathlib import Path
from uuid import uuid4

from scrollintel.core.audit_system import (
    audit_system, AuditAction, ComplianceLevel, RetentionPolicy
)
from scrollintel.core.compliance_manager import (
    compliance_manager, ComplianceFramework, DataClassification
)


async def demo_basic_audit_logging():
    """Demonstrate basic audit logging functionality"""
    print("\nüîç Basic Audit Logging Demo")
    print("=" * 40)
    
    # Sample user data
    user_id = str(uuid4())
    user_email = "demo@scrollintel.com"
    session_id = "demo_session_123"
    ip_address = "192.168.1.100"
    
    print(f"üë§ Demo User: {user_email}")
    print(f"üîó Session ID: {session_id}")
    print(f"üåê IP Address: {ip_address}")
    
    # Log various user actions
    actions_to_log = [
        {
            "action": AuditAction.LOGIN_SUCCESS,
            "resource_type": "authentication",
            "details": {"login_method": "password", "mfa_enabled": True}
        },
        {
            "action": AuditAction.DATA_UPLOAD,
            "resource_type": "dataset",
            "resource_id": "dataset_123",
            "resource_name": "Customer_Data.csv",
            "details": {"file_size": 2048000, "rows": 10000, "columns": 15}
        },
        {
            "action": AuditAction.DASHBOARD_CREATE,
            "resource_type": "dashboard",
            "resource_id": "dashboard_456",
            "resource_name": "Sales Analytics Dashboard",
            "details": {"chart_count": 5, "data_sources": 2}
        },
        {
            "action": AuditAction.MODEL_TRAIN,
            "resource_type": "ml_model",
            "resource_id": "model_789",
            "resource_name": "Customer Churn Predictor",
            "details": {"algorithm": "random_forest", "accuracy": 0.92, "training_time": 300}
        },
        {
            "action": AuditAction.API_REQUEST,
            "resource_type": "api_endpoint",
            "resource_id": "/api/predictions",
            "details": {"method": "POST", "response_time": 0.15, "status_code": 200}
        }
    ]
    
    print(f"\nüìù Logging {len(actions_to_log)} audit events...")
    
    event_ids = []
    for action_data in actions_to_log:
        event_id = await audit_system.log_user_action(
            user_id=user_id,
            user_email=user_email,
            session_id=session_id,
            ip_address=ip_address,
            user_agent="ScrollIntel Demo Client v1.0",
            **action_data
        )
        event_ids.append(event_id)
        print(f"  ‚úÖ {action_data['action'].value} -> {event_id[:8]}...")
    
    # Wait for background processing
    await asyncio.sleep(0.5)
    
    print(f"\n‚ú® Successfully logged {len(event_ids)} audit events!")
    return user_id, event_ids


async def demo_audit_log_search():
    """Demonstrate audit log search and filtering"""
    print("\nüîç Audit Log Search Demo")
    print("=" * 40)
    
    # Search with various filters
    search_scenarios = [
        {
            "name": "All Recent Logs",
            "filters": {
                "start_date": datetime.utcnow() - timedelta(hours=1),
                "limit": 10
            }
        },
        {
            "name": "Authentication Events",
            "filters": {
                "action": AuditAction.LOGIN_SUCCESS.value,
                "resource_type": "authentication",
                "limit": 5
            }
        },
        {
            "name": "Data Operations",
            "filters": {
                "resource_type": "dataset",
                "start_date": datetime.utcnow() - timedelta(hours=1),
                "limit": 5
            }
        },
        {
            "name": "Failed Operations",
            "filters": {
                "success": False,
                "start_date": datetime.utcnow() - timedelta(days=1),
                "limit": 5
            }
        }
    ]
    
    for scenario in search_scenarios:
        print(f"\nüîé Searching: {scenario['name']}")
        
        try:
            logs = await audit_system.search_audit_logs(**scenario['filters'])
            print(f"  üìä Found {len(logs)} matching logs")
            
            for log in logs[:3]:  # Show first 3
                timestamp = datetime.fromisoformat(log['timestamp']).strftime("%H:%M:%S")
                print(f"    ‚Ä¢ {timestamp}: {log['action']} on {log['resource_type']}")
                
        except Exception as e:
            print(f"  ‚ùå Search failed: {e}")
    
    print("\n‚ú® Audit log search completed!")


async def demo_compliance_reporting():
    """Demonstrate compliance reporting functionality"""
    print("\nüìã Compliance Reporting Demo")
    print("=" * 40)
    
    # Generate compliance report
    start_date = datetime.utcnow() - timedelta(days=7)
    end_date = datetime.utcnow()
    
    print(f"üìÖ Report Period: {start_date.strftime('%Y-%m-%d')} to {end_date.strftime('%Y-%m-%d')}")
    
    try:
        report = await audit_system.generate_compliance_report(
            start_date=start_date,
            end_date=end_date,
            report_type="comprehensive"
        )
        
        print(f"\nüìä Compliance Report Generated:")
        print(f"  üî¢ Total Events: {report.total_events}")
        print(f"  ‚úÖ Successful Events: {report.successful_events}")
        print(f"  ‚ùå Failed Events: {report.failed_events}")
        print(f"  üîí Security Events: {report.security_events}")
        print(f"  ‚ö†Ô∏è  Compliance Violations: {len(report.compliance_violations)}")
        
        if report.compliance_violations:
            print(f"\n‚ö†Ô∏è  Recent Violations:")
            for violation in report.compliance_violations[:3]:
                print(f"    ‚Ä¢ {violation['action']} - {violation.get('error_message', 'Unknown error')}")
        
        print(f"\nüë• User Activity Summary:")
        for user_id, count in list(report.user_activity_summary.items())[:5]:
            print(f"    ‚Ä¢ User {user_id[:8]}...: {count} actions")
        
        print(f"\nüìÅ Resource Access Summary:")
        for resource_type, count in list(report.resource_access_summary.items())[:5]:
            print(f"    ‚Ä¢ {resource_type}: {count} accesses")
        
        print(f"\nüí° Recommendations:")
        for rec in report.recommendations:
            print(f"    ‚Ä¢ {rec}")
        
    except Exception as e:
        print(f"‚ùå Report generation failed: {e}")
    
    print("\n‚ú® Compliance reporting completed!")


async def demo_compliance_framework_analysis():
    """Demonstrate compliance framework-specific analysis"""
    print("\nüèõÔ∏è Compliance Framework Analysis Demo")
    print("=" * 40)
    
    frameworks_to_test = [
        ComplianceFramework.GDPR,
        ComplianceFramework.SOX,
        ComplianceFramework.ISO_27001
    ]
    
    start_date = datetime.utcnow() - timedelta(days=30)
    end_date = datetime.utcnow()
    
    for framework in frameworks_to_test:
        print(f"\nüîç Analyzing {framework.value.upper()} Compliance...")
        
        try:
            report = await compliance_manager.generate_compliance_report(
                framework=framework,
                start_date=start_date,
                end_date=end_date
            )
            
            print(f"  üìä Events Analyzed: {report['summary']['total_events_analyzed']}")
            print(f"  ‚ö†Ô∏è  Violations Found: {report['summary']['total_violations']}")
            print(f"  üìà Compliance Rate: {report['summary']['compliance_rate']:.1f}%")
            print(f"  üìã Rules Evaluated: {report['summary']['rules_evaluated']}")
            
            if report['recommendations']:
                print(f"  üí° Top Recommendation: {report['recommendations'][0]}")
            
        except Exception as e:
            print(f"  ‚ùå Analysis failed: {e}")
    
    print("\n‚ú® Framework analysis completed!")


async def demo_data_retention_policies():
    """Demonstrate data retention policy management"""
    print("\nüóÇÔ∏è Data Retention Policies Demo")
    print("=" * 40)
    
    # Show current retention policies
    policies = compliance_manager.retention_policies
    
    print(f"üìã Active Retention Policies ({len(policies)}):")
    for policy_id, policy in policies.items():
        print(f"\n  üìÅ {policy.name}")
        print(f"    ‚Ä¢ ID: {policy_id}")
        print(f"    ‚Ä¢ Data Types: {', '.join(policy.data_types)}")
        print(f"    ‚Ä¢ Retention Period: {policy.retention_period.value}")
        print(f"    ‚Ä¢ Deletion Method: {policy.deletion_method}")
        print(f"    ‚Ä¢ Auto Cleanup: {'‚úÖ' if policy.auto_cleanup else '‚ùå'}")
        print(f"    ‚Ä¢ Frameworks: {', '.join([f.value for f in policy.compliance_frameworks])}")
    
    # Simulate retention policy application
    print(f"\nüßπ Applying Retention Policies...")
    
    try:
        cleanup_results = await compliance_manager.apply_retention_policies()
        
        print(f"üìä Cleanup Results:")
        total_cleaned = 0
        for policy_id, count in cleanup_results.items():
            if count >= 0:
                print(f"  ‚Ä¢ {policy_id}: {count} records cleaned")
                total_cleaned += count
            else:
                print(f"  ‚Ä¢ {policy_id}: ‚ùå Error during cleanup")
        
        print(f"\n‚ú® Total Records Cleaned: {total_cleaned}")
        
    except Exception as e:
        print(f"‚ùå Retention policy application failed: {e}")
    
    print("\n‚ú® Data retention demo completed!")


async def demo_audit_export():
    """Demonstrate audit log export functionality"""
    print("\nüì§ Audit Log Export Demo")
    print("=" * 40)
    
    start_date = datetime.utcnow() - timedelta(days=7)
    end_date = datetime.utcnow()
    
    export_formats = ["json", "csv"]
    
    for format_type in export_formats:
        print(f"\nüìÑ Exporting audit logs as {format_type.upper()}...")
        
        try:
            file_path = await audit_system.export_audit_logs(
                start_date=start_date,
                end_date=end_date,
                format=format_type,
                action=AuditAction.DATA_UPLOAD.value  # Filter for data upload events
            )
            
            export_file = Path(file_path)
            if export_file.exists():
                file_size = export_file.stat().st_size
                print(f"  ‚úÖ Export successful!")
                print(f"  üìÅ File: {export_file.name}")
                print(f"  üìä Size: {file_size:,} bytes")
                
                # Show sample content for JSON
                if format_type == "json" and file_size < 10000:  # Only for small files
                    with open(export_file, 'r') as f:
                        data = json.load(f)
                        print(f"  üìã Records: {len(data.get('audit_logs', []))}")
                        print(f"  üìÖ Date Range: {data['export_metadata']['date_range_start']} to {data['export_metadata']['date_range_end']}")
                
                # Cleanup demo files
                export_file.unlink()
                print(f"  üßπ Demo file cleaned up")
            else:
                print(f"  ‚ùå Export file not found")
                
        except Exception as e:
            print(f"  ‚ùå Export failed: {e}")
    
    print("\n‚ú® Audit export demo completed!")


async def demo_compliance_violation_detection():
    """Demonstrate compliance violation detection"""
    print("\n‚ö†Ô∏è Compliance Violation Detection Demo")
    print("=" * 40)
    
    # Simulate various scenarios that might trigger violations
    test_scenarios = [
        {
            "name": "GDPR Personal Data Access",
            "action": "access",
            "resource_type": "personal_data",
            "resource_id": "user_profile_123",
            "user_id": "user_456",
            "data_classification": DataClassification.CONFIDENTIAL
        },
        {
            "name": "SOX Financial Data Modification",
            "action": "modify",
            "resource_type": "financial_data",
            "resource_id": "billing_record_789",
            "user_id": "user_789",
            "data_classification": DataClassification.RESTRICTED
        },
        {
            "name": "Regular Dashboard Access",
            "action": "view",
            "resource_type": "dashboard",
            "resource_id": "dashboard_123",
            "user_id": "user_456",
            "data_classification": DataClassification.INTERNAL
        }
    ]
    
    for scenario in test_scenarios:
        print(f"\nüß™ Testing: {scenario['name']}")
        
        try:
            violations = await compliance_manager.check_compliance(
                action=scenario["action"],
                resource_type=scenario["resource_type"],
                resource_id=scenario["resource_id"],
                user_id=scenario["user_id"],
                data_classification=scenario["data_classification"]
            )
            
            if violations:
                print(f"  ‚ö†Ô∏è  {len(violations)} violation(s) detected:")
                for violation in violations:
                    print(f"    ‚Ä¢ Rule: {violation.rule_id}")
                    print(f"    ‚Ä¢ Severity: {violation.severity}")
                    print(f"    ‚Ä¢ Description: {violation.description}")
            else:
                print(f"  ‚úÖ No violations detected")
                
        except Exception as e:
            print(f"  ‚ùå Violation check failed: {e}")
    
    # Wait for background processing
    await asyncio.sleep(0.5)
    
    print("\n‚ú® Violation detection demo completed!")


async def demo_system_statistics():
    """Demonstrate audit system statistics and metrics"""
    print("\nüìä System Statistics Demo")
    print("=" * 40)
    
    # Generate some sample statistics
    start_date = datetime.utcnow() - timedelta(days=30)
    end_date = datetime.utcnow()
    
    try:
        # Generate a compliance report for statistics
        report = await audit_system.generate_compliance_report(
            start_date=start_date,
            end_date=end_date,
            report_type="statistics"
        )
        
        print(f"üìà System Statistics (Last 30 Days):")
        print(f"  üî¢ Total Events: {report.total_events:,}")
        print(f"  ‚úÖ Success Rate: {(report.successful_events / report.total_events * 100):.1f}%" if report.total_events > 0 else "  ‚úÖ Success Rate: N/A")
        print(f"  ‚ùå Failed Events: {report.failed_events:,}")
        print(f"  üîí Security Events: {report.security_events:,}")
        print(f"  ‚ö†Ô∏è  Violations: {len(report.compliance_violations):,}")
        
        print(f"\nüë• User Activity:")
        print(f"  üèÉ Active Users: {len(report.user_activity_summary)}")
        
        print(f"\nüìÅ Resource Access:")
        print(f"  üìä Resource Types: {len(report.resource_access_summary)}")
        
        if report.resource_access_summary:
            top_resources = sorted(
                report.resource_access_summary.items(),
                key=lambda x: x[1],
                reverse=True
            )[:5]
            
            print(f"  üîù Top Resources:")
            for resource_type, count in top_resources:
                print(f"    ‚Ä¢ {resource_type}: {count:,} accesses")
        
        print(f"\nüí° System Health:")
        if report.recommendations:
            for rec in report.recommendations[:3]:
                print(f"  ‚Ä¢ {rec}")
        else:
            print(f"  ‚úÖ All systems operating normally")
        
    except Exception as e:
        print(f"‚ùå Statistics generation failed: {e}")
    
    print("\n‚ú® Statistics demo completed!")


async def main():
    """Run the complete audit and compliance demo"""
    print("üöÄ ScrollIntel Audit Logging & Compliance System Demo")
    print("=" * 60)
    print("Demonstrating comprehensive audit logging, compliance reporting,")
    print("data retention policies, and audit trail export capabilities.")
    print("=" * 60)
    
    try:
        # Start the audit and compliance systems
        await audit_system.start()
        await compliance_manager.start()
        
        # Run all demos
        await demo_basic_audit_logging()
        await demo_audit_log_search()
        await demo_compliance_reporting()
        await demo_compliance_framework_analysis()
        await demo_data_retention_policies()
        await demo_audit_export()
        await demo_compliance_violation_detection()
        await demo_system_statistics()
        
        print("\n" + "=" * 60)
        print("üéâ Demo Completed Successfully!")
        print("=" * 60)
        
        print("\nüìã Key Features Demonstrated:")
        print("  ‚úÖ Comprehensive audit logging for all user actions")
        print("  ‚úÖ Advanced audit log search and filtering")
        print("  ‚úÖ Compliance reporting with multiple frameworks")
        print("  ‚úÖ Data retention policies and automated cleanup")
        print("  ‚úÖ Audit trail export in JSON and CSV formats")
        print("  ‚úÖ Real-time compliance violation detection")
        print("  ‚úÖ System statistics and health monitoring")
        
        print("\nüîí Compliance Frameworks Supported:")
        print("  ‚Ä¢ GDPR (General Data Protection Regulation)")
        print("  ‚Ä¢ SOX (Sarbanes-Oxley Act)")
        print("  ‚Ä¢ ISO 27001 (Information Security Management)")
        print("  ‚Ä¢ HIPAA (Health Insurance Portability)")
        print("  ‚Ä¢ PCI DSS (Payment Card Industry)")
        print("  ‚Ä¢ NIST (National Institute of Standards)")
        
        print("\nüìä Production Ready Features:")
        print("  ‚Ä¢ Background processing for high performance")
        print("  ‚Ä¢ Structured logging with JSON format")
        print("  ‚Ä¢ Automated data retention and cleanup")
        print("  ‚Ä¢ Real-time violation detection and alerting")
        print("  ‚Ä¢ Comprehensive API endpoints for integration")
        print("  ‚Ä¢ Export capabilities for compliance audits")
        
        print("\nüöÄ The system is ready for production deployment!")
        
    except Exception as e:
        print(f"\n‚ùå Demo failed: {e}")
        import traceback
        traceback.print_exc()
        
    finally:
        # Stop the systems
        await audit_system.stop()
        await compliance_manager.stop()


if __name__ == "__main__":
    asyncio.run(main())